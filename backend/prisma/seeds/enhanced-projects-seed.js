import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export async function seedEnhancedProjects() {
  console.log('üå± Seeding enhanced projects data...');

  // Obtener usuarios para asignar como managers e inspectores
  const users = await prisma.user.findMany({ take: 5 });
  if (users.length === 0) {
    console.log('‚ö†Ô∏è  No users found. Skipping enhanced projects seed.');
    return;
  }

  const managerId = users[0].id;
  const inspectorId = users[1]?.id || users[0].id;

  // 1. Crear Contratistas
  console.log('Creating contractors...');
  const contractors = await Promise.all([
    prisma.contractor.upsert({
      where: { rif: 'J-123456789' },
      update: {},
      create: {
        rif: 'J-123456789',
        name: 'Construcciones El Progreso C.A.',
        legalRepresentative: 'Carlos Rodr√≠guez',
        phone: '+58-212-5551234',
        email: 'info@elprogreso.com',
        address: 'Av. Principal, Edificio Centro, Piso 3, Caracas',
        specialty: 'Construcci√≥n y Obra Civil',
        yearsExperience: 15,
        isActive: true,
        averageRating: 4.5,
      },
    }),
    prisma.contractor.upsert({
      where: { rif: 'J-987654321' },
      update: {},
      create: {
        rif: 'J-987654321',
        name: 'Ingenier√≠a y Vialidad S.A.',
        legalRepresentative: 'Mar√≠a Gonz√°lez',
        phone: '+58-212-5555678',
        email: 'contacto@vialidad.com',
        address: 'Calle Comercio, Centro Empresarial, Caracas',
        specialty: 'Vialidad y Pavimentaci√≥n',
        yearsExperience: 20,
        isActive: true,
        averageRating: 4.8,
      },
    }),
    prisma.contractor.upsert({
      where: { rif: 'J-456789123' },
      update: {},
      create: {
        rif: 'J-456789123',
        name: 'Servicios Integrales del Municipio',
        legalRepresentative: 'Pedro Mart√≠nez',
        phone: '+58-212-5559999',
        email: 'sim@email.com',
        address: 'Zona Industrial, Galp√≥n 5, Caracas',
        specialty: 'Servicios Generales',
        yearsExperience: 8,
        isActive: true,
        averageRating: 3.9,
      },
    }),
  ]);

  console.log(`‚úÖ Created ${contractors.length} contractors`);

  // 2. Crear Proyectos Mejorados
  console.log('Creating enhanced projects...');

  // Proyecto 1: Reparaci√≥n de Avenida Principal
  const project1 = await prisma.project.upsert({
    where: { code: 'PRO-2025-001' },
    update: {},
    create: {
      code: 'PRO-2025-001',
      name: 'Reparaci√≥n de Avenida Principal',
      description: 'Proyecto integral de reparaci√≥n y mejoramiento de la Avenida Principal, incluyendo pavimentaci√≥n, se√±alizaci√≥n y drenaje.',
      budget: 850000.00,
      fundingSource: 'Presupuesto Ordinario Municipal + FUS',
      status: 'IN_PROGRESS',
      priority: 'HIGH',
      projectType: 'OBRA_CIVIL',
      origin: 'PLAN_GOBIERNO',
      startDate: new Date('2025-01-15'),
      endDate: new Date('2025-06-30'),
      actualStartDate: new Date('2025-01-20'),
      location: 'Avenida Principal, desde Plaza Bol√≠var hasta Redoma El Obelisco',
      latitude: 10.4806,
      longitude: -66.9036,
      sector: 'Centro',
      category: 'Vialidad',
      beneficiaries: 25000,
      managerId,
      justification: 'La Avenida Principal presenta deterioro severo del pavimento que afecta la movilidad de m√°s de 25,000 ciudadanos diariamente y genera riesgos de accidentes vehiculares.',
      generalObjective: 'Mejorar las condiciones de transitabilidad y seguridad vial de la Avenida Principal del municipio.',
      specificObjectives: '1. Reparar 3.5 km de pavimento asf√°ltico\n2. Instalar nueva se√±alizaci√≥n horizontal y vertical\n3. Rehabilitar sistema de drenaje\n4. Mejorar iluminaci√≥n vial',
      quantifiableGoals: '- 3.5 km de v√≠a reparada\n- 120 se√±ales viales instaladas\n- 45 sumideros rehabilitados\n- 80 luminarias LED instaladas',
      technicalDescription: 'Proyecto que contempla fresado de carpeta asf√°ltica existente, reparaci√≥n de base granular, aplicaci√≥n de riego de liga y nueva carpeta asf√°ltica de 5cm.',
      technicalSpecifications: 'Concreto asf√°ltico tipo IV, resistencia m√≠nima 280 kg/cm¬≤, agregados de calidad certificada, se√±alizaci√≥n reflectiva grado diamante.',
      plannedProgress: 65,
      actualProgress: 58,
    },
  });

  // Proyecto 2: Construcci√≥n de Centro de Salud
  const project2 = await prisma.project.upsert({
    where: { code: 'PRO-2025-002' },
    update: {},
    create: {
      code: 'PRO-2025-002',
      name: 'Construcci√≥n de Centro de Salud Comunal',
      description: 'Construcci√≥n de centro de atenci√≥n primaria en salud para la parroquia San Jos√©.',
      budget: 1250000.00,
      fundingSource: 'Fontur + Presupuesto Municipal',
      status: 'APPROVED',
      priority: 'CRITICAL',
      projectType: 'SOCIAL',
      origin: 'PRESUPUESTO_PARTICIPATIVO',
      startDate: new Date('2025-03-01'),
      endDate: new Date('2025-12-31'),
      location: 'Sector La Esperanza, terreno municipal lote 15',
      latitude: 10.4905,
      longitude: -66.8845,
      sector: 'Norte',
      category: 'Salud',
      beneficiaries: 15000,
      managerId,
      justification: 'La parroquia San Jos√© carece de infraestructura de salud adecuada, obligando a los residentes a desplazarse m√°s de 10km para atenci√≥n m√©dica b√°sica.',
      generalObjective: 'Garantizar el acceso a servicios de salud primaria para la poblaci√≥n de la parroquia San Jos√©.',
      specificObjectives: '1. Construir edificaci√≥n de 400m¬≤ con consultorios y √°rea de emergencia\n2. Dotar de equipamiento m√©dico b√°sico\n3. Capacitar personal de salud comunitaria',
      quantifiableGoals: '- 400m¬≤ de construcci√≥n\n- 6 consultorios m√©dicos\n- 1 √°rea de emergencia 24h\n- 20 personas capacitadas',
      technicalDescription: 'Edificaci√≥n de una planta en concreto armado, techos met√°licos, acabados sanitarios de alta calidad.',
      technicalSpecifications: 'Concreto f\'c=210 kg/cm¬≤, acero corrugado grado 60, instalaciones el√©ctricas y sanitarias seg√∫n normas de salud.',
      plannedProgress: 0,
      actualProgress: 0,
    },
  });

  // Proyecto 3: Sistema de Recolecci√≥n de Desechos
  const project3 = await prisma.project.upsert({
    where: { code: 'PRO-2025-003' },
    update: {},
    create: {
      code: 'PRO-2025-003',
      name: 'Modernizaci√≥n del Sistema de Recolecci√≥n de Desechos S√≥lidos',
      description: 'Adquisici√≥n de equipos y modernizaci√≥n del servicio de aseo urbano.',
      budget: 450000.00,
      fundingSource: 'Presupuesto Ordinario',
      status: 'PLANNING',
      priority: 'MEDIUM',
      projectType: 'INSTITUCIONAL',
      origin: 'PLAN_GOBIERNO',
      startDate: new Date('2025-04-01'),
      endDate: new Date('2025-07-31'),
      location: 'Todo el municipio - Base operativa Zona Industrial',
      latitude: 10.4750,
      longitude: -66.9150,
      sector: 'Municipal',
      category: 'Ambiente',
      beneficiaries: 80000,
      managerId,
      justification: 'El servicio de recolecci√≥n actual es deficiente debido a la antig√ºedad de los equipos (m√°s de 15 a√±os), generando acumulaci√≥n de desechos en v√≠as p√∫blicas.',
      generalObjective: 'Mejorar la eficiencia y cobertura del servicio de recolecci√≥n de desechos s√≥lidos en todo el municipio.',
      specificObjectives: '1. Adquirir 3 camiones compactadores nuevos\n2. Implementar sistema de rutas optimizadas\n3. Capacitar al personal operativo',
      quantifiableGoals: '- 3 camiones compactadores 16m¬≥\n- Cobertura del 95% del municipio\n- Reducci√≥n del 40% en tiempo de recolecci√≥n',
      plannedProgress: 0,
      actualProgress: 0,
    },
  });

  console.log(`‚úÖ Created 3 enhanced projects`);

  // 3. Crear Contratos
  console.log('Creating contracts...');
  const contract1 = await prisma.projectContract.create({
    data: {
      projectId: project1.id,
      contractNumber: 'CONT-2025-001',
      type: 'LICITACION_PUBLICA',
      status: 'EN_EJECUCION',
      description: 'Contrato para ejecuci√≥n de obras de reparaci√≥n vial en Avenida Principal seg√∫n especificaciones t√©cnicas del proyecto.',
      contractAmount: 820000.00,
      bidOpeningDate: new Date('2024-12-10'),
      adjudicationDate: new Date('2024-12-20'),
      signedDate: new Date('2025-01-05'),
      startDate: new Date('2025-01-15'),
      endDate: new Date('2025-06-30'),
      contractorId: contractors[1].id,
      advancePayment: 164000.00, // 20% anticipo
      advancePaymentPercent: 20,
      retentionPercent: 10,
      paidAmount: 410000.00, // 50% pagado
    },
  });

  const contract2 = await prisma.projectContract.create({
    data: {
      projectId: project2.id,
      contractNumber: 'CONT-2025-002',
      type: 'LICITACION_PUBLICA',
      status: 'FIRMADO',
      description: 'Construcci√≥n de Centro de Salud Comunal incluyendo obra civil, instalaciones y equipamiento.',
      contractAmount: 1200000.00,
      bidOpeningDate: new Date('2025-01-15'),
      adjudicationDate: new Date('2025-02-01'),
      signedDate: new Date('2025-02-15'),
      startDate: new Date('2025-03-01'),
      endDate: new Date('2025-12-31'),
      contractorId: contractors[0].id,
      advancePayment: 240000.00,
      advancePaymentPercent: 20,
      retentionPercent: 10,
      paidAmount: 240000.00,
    },
  });

  console.log(`‚úÖ Created 2 contracts`);

  // 4. Crear Documentos T√©cnicos
  console.log('Creating technical documents...');
  await Promise.all([
    prisma.projectDocument.create({
      data: {
        projectId: project1.id,
        name: 'Plano de Ubicaci√≥n General',
        description: 'Plano topogr√°fico con ubicaci√≥n exacta del proyecto',
        type: 'PLANO',
        fileUrl: '/documents/pro-001-plano-ubicacion.pdf',
        fileSize: 2048000,
        uploadedBy: managerId,
        version: '1.0',
      },
    }),
    prisma.projectDocument.create({
      data: {
        projectId: project1.id,
        name: 'Especificaciones T√©cnicas de Pavimento',
        description: 'Especificaciones detalladas del concreto asf√°ltico a utilizar',
        type: 'ESPECIFICACION',
        fileUrl: '/documents/pro-001-especificaciones-pavimento.pdf',
        fileSize: 1024000,
        uploadedBy: managerId,
        version: '2.0',
      },
    }),
    prisma.projectDocument.create({
      data: {
        projectId: project1.id,
        name: 'Presupuesto Detallado',
        description: 'APU y presupuesto desglosado por partidas',
        type: 'PRESUPUESTO',
        fileUrl: '/documents/pro-001-presupuesto.xlsx',
        fileSize: 512000,
        uploadedBy: managerId,
        version: '1.5',
      },
    }),
    prisma.projectDocument.create({
      data: {
        projectId: project2.id,
        name: 'Planos Arquitect√≥nicos',
        description: 'Planos de plantas, cortes y fachadas del centro de salud',
        type: 'PLANO',
        fileUrl: '/documents/pro-002-planos-arquitectonicos.dwg',
        fileSize: 5120000,
        uploadedBy: managerId,
        version: '3.0',
      },
    }),
    prisma.projectDocument.create({
      data: {
        projectId: project2.id,
        name: 'Estudio de Suelos',
        description: 'An√°lisis geot√©cnico del terreno',
        type: 'ESTUDIO',
        fileUrl: '/documents/pro-002-estudio-suelos.pdf',
        fileSize: 3072000,
        uploadedBy: managerId,
        version: '1.0',
      },
    }),
  ]);

  console.log('‚úÖ Created 5 technical documents');

  // 5. Crear Inspecciones
  console.log('Creating inspections...');
  await Promise.all([
    prisma.projectInspection.create({
      data: {
        projectId: project1.id,
        inspectionNumber: 'INSP-2025-001',
        type: 'TECNICA',
        status: 'CERRADA',
        result: 'APROBADO',
        scheduledDate: new Date('2025-02-15'),
        completedDate: new Date('2025-02-15'),
        location: 'Tramo 1 - Km 0+000 al 0+500',
        inspectorId,
        observations: 'Avance conforme a planificado. Calidad del pavimento cumple especificaciones. Espesor verificado con testigos.',
        nonConformities: 'Ninguna',
        correctiveActions: 'N/A',
        followUpRequired: false,
      },
    }),
    prisma.projectInspection.create({
      data: {
        projectId: project1.id,
        inspectionNumber: 'INSP-2025-002',
        type: 'CALIDAD',
        status: 'REALIZADA',
        result: 'CON_OBSERVACIONES',
        scheduledDate: new Date('2025-03-01'),
        completedDate: new Date('2025-03-01'),
        location: 'Tramo 2 - Km 1+000 al 1+500',
        inspectorId,
        observations: 'Se detectaron irregularidades menores en juntas de dilataci√≥n.',
        nonConformities: 'Juntas de dilataci√≥n no cumplen espaciamiento m√≠nimo en 3 puntos',
        correctiveActions: 'Corregir espaciamiento de juntas en los puntos se√±alados. Plazo: 5 d√≠as h√°biles.',
        followUpRequired: true,
        followUpDate: new Date('2025-03-08'),
      },
    }),
    prisma.projectInspection.create({
      data: {
        projectId: project1.id,
        inspectionNumber: 'INSP-2025-003',
        type: 'SEGURIDAD',
        status: 'PROGRAMADA',
        scheduledDate: new Date('2025-05-15'),
        location: 'Todo el proyecto',
        inspectorId,
        observations: null,
        followUpRequired: false,
      },
    }),
  ]);

  console.log('‚úÖ Created 3 inspections');

  // 6. Crear √ìrdenes de Cambio
  console.log('Creating change orders...');
  await Promise.all([
    prisma.changeOrder.create({
      data: {
        projectId: project1.id,
        orderNumber: 'OC-2025-001',
        description: 'Ampliaci√≥n de alcance: Reparaci√≥n de 500m adicionales de v√≠a',
        justification: 'Durante la ejecuci√≥n se detect√≥ que el tramo adyacente requiere reparaci√≥n urgente para evitar da√±os mayores.',
        requestedBy: 'CONTRATISTA',
        status: 'APROBADO',
        costImpact: 95000.00,
        timeImpact: 15, // 15 d√≠as adicionales
        requestDate: new Date('2025-02-20'),
        reviewDate: new Date('2025-02-25'),
        approvalDate: new Date('2025-03-01'),
        requestedByUserId: managerId,
        reviewedByUserId: managerId,
        approvedByUserId: managerId,
        reviewNotes: 'Revisado y considerado necesario para la integridad del proyecto.',
      },
    }),
    prisma.changeOrder.create({
      data: {
        projectId: project1.id,
        orderNumber: 'OC-2025-002',
        description: 'Modificaci√≥n del sistema de drenaje por interferencias encontradas',
        justification: 'Se encontraron tuber√≠as de agua potable no registradas en planos que interfieren con el dise√±o original del drenaje.',
        requestedBy: 'INSPECTOR',
        status: 'EN_REVISION',
        costImpact: 35000.00,
        timeImpact: 8,
        requestDate: new Date('2025-03-15'),
        requestedByUserId: inspectorId,
        reviewNotes: null,
      },
    }),
  ]);

  console.log('‚úÖ Created 2 change orders');

  // 7. Crear Reportes de Avance
  console.log('Creating progress reports...');
  await Promise.all([
    prisma.progressReport.create({
      data: {
        projectId: project1.id,
        reportNumber: 'REP-PRO-2025-001-001',
        reportDate: new Date('2025-02-01'),
        periodStart: new Date('2025-01-20'),
        periodEnd: new Date('2025-01-31'),
        physicalProgress: 15,
        plannedProgress: 18,
        variance: -3,
        executedAmount: 123000.00,
        accumulatedAmount: 123000.00,
        activitiesCompleted: '- Limpieza y preparaci√≥n del sitio\n- Fresado de 800m de carpeta asf√°ltica\n- Reparaci√≥n de base en 500m',
        activitiesInProgress: '- Aplicaci√≥n de riego de liga\n- Colocaci√≥n de nueva carpeta asf√°ltica',
        plannedActivities: '- Completar asfaltado tramo 1\n- Iniciar se√±alizaci√≥n',
        observations: 'Avance ligeramente por debajo de lo planificado debido a lluvias en la primera semana.',
        issues: 'Retraso de 3 d√≠as por condiciones clim√°ticas adversas',
        risks: 'Riesgo de nuevas lluvias en febrero que podr√≠an afectar el cronograma',
        weatherConditions: 'Lluvioso primera semana, soleado resto del per√≠odo',
        workDays: 8,
        reportedBy: managerId,
      },
    }),
    prisma.progressReport.create({
      data: {
        projectId: project1.id,
        reportNumber: 'REP-PRO-2025-001-002',
        reportDate: new Date('2025-03-01'),
        periodStart: new Date('2025-02-01'),
        periodEnd: new Date('2025-02-28'),
        physicalProgress: 38,
        plannedProgress: 35,
        variance: 3,
        executedAmount: 189000.00,
        accumulatedAmount: 312000.00,
        activitiesCompleted: '- Asfaltado completo tramo 1 (1.2 km)\n- Instalaci√≥n de 45 se√±ales verticales\n- Pintura de 800m de marcas viales',
        activitiesInProgress: '- Fresado tramo 2\n- Rehabilitaci√≥n de sumideros',
        plannedActivities: '- Completar tramo 2\n- Instalar iluminaci√≥n LED',
        observations: 'Excelente avance durante febrero. Se recuper√≥ el retraso del mes anterior.',
        issues: 'Ninguno significativo',
        risks: 'Ninguno identificado',
        weatherConditions: 'Soleado, condiciones √≥ptimas',
        workDays: 20,
        reportedBy: managerId,
      },
    }),
  ]);

  console.log('‚úÖ Created 2 progress reports');

  console.log('‚úÖ Enhanced projects seed completed successfully!');
}

// Ejecutar si se llama directamente
if (import.meta.url === `file://${process.argv[1]}`) {
  seedEnhancedProjects()
    .catch((e) => {
      console.error('‚ùå Error seeding enhanced projects:', e);
      process.exit(1);
    })
    .finally(async () => {
      await prisma.$disconnect();
    });
}
